# Automatically generated on 2022-05-06 UTC from https://codemagic.io/app/600a00945662141a7e193e58/settings
# Note that this configuration is not an exact match to UI settings. Review and adjust as necessary.

workflows:
  # dev-(android):
  #   name: dev (Android)
  #   max_build_duration: 120
  #   environment:
  #     groups:
  #       - firestore_secrets_dev
  #       - keystore_credentials_dev
  #       - google_play_dev
  #     vars:
  #       CM_KEYSTORE_PATH: /tmp/keystore.keystore
  #       PACKAGE_NAME: 'com.aperezpe.bonobo'
  #       GOOGLE_PLAY_TRACK: 'beta'
  #     flutter: 2.2.3
  #     xcode: latest
  #     cocoapods: default
  #   triggering:
  #     events:
  #       - push
  #     branch_patterns:
  #       - pattern: '*dev*'
  #         include: true
  #         source: true
  #     tag_patterns:
  #       - pattern: '*'
  #         include: true
    
  #   scripts:
  #     - name: Setup Google Services
  #       script: |
  #         echo $ANDROID_FIREBASE_SECRET | base64 --decode > $CM_BUILD_DIR/android/app/google-services.json
  #     - name: Setup key properties
  #       script: |
  #         echo $CM_KEYSTORE | base64 --decode > /tmp/keystore.keystore
  #         cat >> "$CM_BUILD_DIR/android/key.properties" <<EOF
  #         storePassword=$CM_KEYSTORE_PASSWORD
  #         keyPassword=$CM_KEY_PASSWORD
  #         keyAlias=$CM_KEY_ALIAS
  #         storeFile=/tmp/keystore.keystore
  #         EOF
  #     - name: Set up local.properties
  #       script: |
  #         echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"
  #     - name: Get Flutter packages
  #       script: |
  #         cd . && flutter packages pub get
  #     - name: Build App Bundle with Flutter
  #       script: |
  #         cd . && flutter build appbundle --release --build-name=1.0.1 --build-number=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks "$GOOGLE_PLAY_TRACK") + 1))
  #   artifacts:
  #     - build/**/outputs/bundle/**/*.aab
  #     - build/**/outputs/apk/**/*.apk
  #     - build/**/outputs/**/mapping.txt
  #     - flutter_drive.log
  #   publishing:
  #     slack:
  #       channel: '#bonobo'
  #       notify_on_build_start: true
  #       notify:
  #         success: true
  #         failure: false
  #     email:
  #       recipients:
  #         - aperezpe01@gmail.com
  #       notify:
  #         success: true
  #         failure: false
  #     google_play:
  #       credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
  #       track: $GOOGLE_PLAY_TRACK
  #       submit_as_draft: true
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    environment:
      # vars:
      #   SIGNING_TYPE: IOS_APP_STORE
      #   SIGNING_TYPE_DEV: IOS_APP_DEVELOPMENT
      groups:
        - appstore_credentials
        # Add the above mentioned group environment variables in Codemagic UI (either in Application/Team variables): 
        # APP_STORE_CONNECT_ISSUER_ID
        # APP_STORE_CONNECT_KEY_IDENTIFIER
        # APP_STORE_CONNECT_PRIVATE_KEY Ã¥
        - signing_cert
        # CERTIFICATE_PRIVATE_KEY
        - firestore_secrets
      flutter: 2.2.3
      xcode: 13.4
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: '*dev*'
          include: true
          source: true
        - pattern: '*uat*'
          include: true
          source: true
      tag_patterns:
        - pattern: '*'
          include: true
    scripts:
      - name: Get flutter packages
        script: flutter pub get
      - name: Saves Firebase Google Services
        script: |
          # Set up google service file based on environment
          case "$CM_BRANCH" in
            uat) IOS_FIREBASE_SECRET="$IOS_FIREBASE_SECRET_UAT" ;;
            main) IOS_FIREBASE_SECRET="$IOS_FIREBASE_SECRET" ;;
            *) IOS_FIREBASE_SECRET="$IOS_FIREBASE_SECRET_DEV" ;;
          esac

          echo $IOS_FIREBASE_SECRET | base64 --decode > $FCI_BUILD_DIR/ios/Runner/GoogleService-Info.plist
          
          # echo $IOS_FIREBASE_SECRET
      - name: Pod install
        script: find . -name "Podfile" -execdir pod install \;
      - name: Set up keychain to be used for code signing using Codemagic CLI 'keychain' command
        script: keychain initialize
      - name: Fetch signing files
        script: |
          # Set up signing type based on environment
          case "$CM_BRANCH" in
            uat) SIGNING_TYPE="IOS_APP_STORE" ;;
            main) SIGNING_TYPE="IOS_APP_STORE" ;;
            *) SIGNING_TYPE="IOS_APP_DEVELOPMENT" ;;
          esac
          echo Signing with type: $SIGNING_TYPE since branch is $CM_BRANCH

          # You can allow creating resources if existing are not found with `--create` flag
          # use --type IOS_APP_DEVELOPMENT together with development signing cert for DEVELOPMENT
          app-store-connect fetch-signing-files "$(xcode-project detect-bundle-id)" --type $SIGNING_TYPE --create      
      - name: Set up signing certificate
        script: keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles
      - name: Build ipa artifact
        # --build-name = CFBundleShortVersionString (Must be different if publishing to App Store)
        # --build-number = CFBundleVersion (Must be different for testing. This code will automatically update it)
        script: |
          # Get Build number for environment specific
          case "$CM_BRANCH" in
            uat) IOS_BUILD_NUMBER=$(($(app-store-connect get-latest-app-store-build-number "$APP_STORE_ID") + 1)) ;;
            main) IOS_BUILD_NUMBER=$(($(app-store-connect get-latest-app-store-build-number "$APP_STORE_ID") + 1)) ;;
            *) IOS_BUILD_NUMBER=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) ;;
          esac

          echo Build number to release: $IOS_BUILD_NUMBER

          flutter build ipa --release --build-name=1.0.2 --build-number=6 --export-options-plist=/Users/builder/export_options.plist 
      # - flutter build ios --debug --no-codesign
      - name: Publish
        script: |
          if [ $CM_BRANCH == "uat"] || [ $CM_BRANCH == "main" ]
          then
            app-store-connect publish \
            --path /Users/builder/clone/build/ios/ipa/gifterest.ipa \ 
            --key-id @env:APP_STORE_CONNECT_KEY_IDENTIFIER \
            --issuer-id @env:APP_STORE_CONNECT_ISSUER_ID \
            --private-key @env:APP_STORE_CONNECT_PRIVATE_KEY
          else
            echo "Build Successful!"
          fi
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # app_store_connect: # For iOS or macOS app
      #   # For authenticating with App Store Connect and uploading the IPA to App Store Connect (required)
      #   api_key: $APP_STORE_CONNECT_PRIVATE_KEY
      #   key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER 
      #   issuer_id: $APP_STORE_CONNECT_ISSUER_ID 
        
        # Configuration related to TestFlight (optional)
        # submit_to_testflight: false # Optional boolean, defaults to false. Whether or not to submit the uploaded build to TestFlight beta review. Required for distributing to beta groups. Note: This action is performed during post-processing.
        # beta_groups: # Specify the names of beta tester groups that will get access to the build once it has passed beta review.
        #   - First Testers
        #   - First External Testers
        
        # Configuration related to App Store (optional)
        # submit_to_app_store: false # Optional boolean, defaults to false. Whether or not to submit the uploaded build to App Store review. Note: This action is performed during post-processing.
        # release_type: MANUAL # Optional, defaults to MANUAL. Supported values: MANUAL, AFTER_APPROVAL or SCHEDULED
        # copyright: 2022 Gifterest # Optional. The name of the person or entity that owns the exclusive rights to your app, preceded by the year the rights were obtained.
      
      slack:
        channel: '#bonobo'
        notify_on_build_start: true
        notify:
          success: true
          failure: false
      email:
        recipients:
          - aperezpe01@gmail.com
        notify:
          success: true
          failure: false
  # uat-(ios):
  #   name: uat (iOS)
  #   max_build_duration: 120
  #   environment:
  #     groups:
  #       - appstore_credentials
  #     # Add the above mentioned group environment variables in Codemagic UI (either in Application/Team variables): 
  #       # APP_STORE_CONNECT_ISSUER_ID
  #       # APP_STORE_CONNECT_KEY_IDENTIFIER
  #       # APP_STORE_CONNECT_PRIVATE_KEY 
  #       # CERTIFICATE_PRIVATE_KEY
  #     vars:
  #       IOS_FIREBASE_SECRET: |-
  #         PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCFET0NUWVBF
  #         IHBsaXN0IFBVQkxJQyAiLS8vQXBwbGUvL0RURCBQTElTVCAxLjAvL0VOIiAiaHR0
  #         cDovL3d3dy5hcHBsZS5jb20vRFREcy9Qcm9wZXJ0eUxpc3QtMS4wLmR0ZCI+Cjxw
  #         bGlzdCB2ZXJzaW9uPSIxLjAiPgo8ZGljdD4KCTxrZXk+Q0xJRU5UX0lEPC9rZXk+
  #         Cgk8c3RyaW5nPjk5OTY5ODgwNjA5NS1zazRxYTlsaWRyc2huNWNzbTQ4NDdlczg0
  #         cnJnaDQ4di5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbTwvc3RyaW5nPgoJPGtl
  #         eT5SRVZFUlNFRF9DTElFTlRfSUQ8L2tleT4KCTxzdHJpbmc+Y29tLmdvb2dsZXVz
  #         ZXJjb250ZW50LmFwcHMuOTk5Njk4ODA2MDk1LXNrNHFhOWxpZHJzaG41Y3NtNDg0
  #         N2VzODRycmdoNDh2PC9zdHJpbmc+Cgk8a2V5PkFORFJPSURfQ0xJRU5UX0lEPC9r
  #         ZXk+Cgk8c3RyaW5nPjk5OTY5ODgwNjA5NS02bGJzZjYxZzMxM3RqYmQxaTU0bG9m
  #         cTUwbGY0Y2dhMS5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbTwvc3RyaW5nPgoJ
  #         PGtleT5BUElfS0VZPC9rZXk+Cgk8c3RyaW5nPkFJemFTeUR2NHVQT3lGeTM0dHlF
  #         eERCdEZaMFhlTzZfYnR3cnhDSTwvc3RyaW5nPgoJPGtleT5HQ01fU0VOREVSX0lE
  #         PC9rZXk+Cgk8c3RyaW5nPjk5OTY5ODgwNjA5NTwvc3RyaW5nPgoJPGtleT5QTElT
  #         VF9WRVJTSU9OPC9rZXk+Cgk8c3RyaW5nPjE8L3N0cmluZz4KCTxrZXk+QlVORExF
  #         X0lEPC9rZXk+Cgk8c3RyaW5nPmNvbS5leGFtcGxlLmJvbm9ibzwvc3RyaW5nPgoJ
  #         PGtleT5QUk9KRUNUX0lEPC9rZXk+Cgk8c3RyaW5nPmltcG9ydGFudC1kYXRlcy1y
  #         ZW1pbmRlcnM8L3N0cmluZz4KCTxrZXk+U1RPUkFHRV9CVUNLRVQ8L2tleT4KCTxz
  #         dHJpbmc+aW1wb3J0YW50LWRhdGVzLXJlbWluZGVycy5hcHBzcG90LmNvbTwvc3Ry
  #         aW5nPgoJPGtleT5JU19BRFNfRU5BQkxFRDwva2V5PgoJPGZhbHNlPjwvZmFsc2U+
  #         Cgk8a2V5PklTX0FOQUxZVElDU19FTkFCTEVEPC9rZXk+Cgk8ZmFsc2U+PC9mYWxz
  #         ZT4KCTxrZXk+SVNfQVBQSU5WSVRFX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1
  #         ZT4KCTxrZXk+SVNfR0NNX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1ZT4KCTxr
  #         ZXk+SVNfU0lHTklOX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1ZT4KCTxrZXk+
  #         R09PR0xFX0FQUF9JRDwva2V5PgoJPHN0cmluZz4xOjk5OTY5ODgwNjA5NTppb3M6
  #         NWVkMGRhYjZiZmUwYTU3MmZlODEzYTwvc3RyaW5nPgoJPGtleT5EQVRBQkFTRV9V
  #         Ukw8L2tleT4KCTxzdHJpbmc+aHR0cHM6Ly9pbXBvcnRhbnQtZGF0ZXMtcmVtaW5k
  #         ZXJzLmZpcmViYXNlaW8uY29tPC9zdHJpbmc+CjwvZGljdD4KPC9wbGlzdD4=
  #     flutter: 2.2.3
  #     xcode: latest
  #     cocoapods: default
  #   triggering:
  #     events:
  #       - push
  #     branch_patterns:
  #       - pattern: '*uat*'
  #         include: true
  #         source: true
  #     tag_patterns:
  #       - pattern: '*'
  #         include: true
  #   scripts:
  #     - flutter pub get
  #     - |
  #       #!/bin/sh

  #       echo $IOS_FIREBASE_SECRET | base64 --decode > $FCI_BUILD_DIR/ios/Runner/GoogleService-Info.plist
  #     - find . -name "Podfile" -execdir pod install \;
  #     - name: Set up keychain to be used for code signing using Codemagic CLI 'keychain' command
  #       script: keychain initialize
  #     - name: Fetch signing files
  #       script: |
  #         # You can allow creating resources if existing are not found with `--create` flag
  #         # use --type IOS_APP_DEVELOPMENT together with development signing cert for DEVELOPMENT
  #         app-store-connect fetch-signing-files "$(xcode-project detect-bundle-id)" \
  #           --type IOS_APP_STORE \
  #           --create      
  #     - name: Set up signing certificate
  #       script: keychain add-certificates
  #     - name: Set up code signing settings on Xcode project
  #       script: xcode-project use-profiles
  #     - name: Build ipa artifact
  #       # --build-name = CFBundleShortVersionString (Must be different if publishing to App Store)
  #       # --build-number = CFBundleVersion (Must be different for testing. This code will automatically update it)
  #       script: |
  #         flutter build ipa --release \
  #         --build-name=1.0.1 \
  #         --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
  #         --export-options-plist=/Users/builder/export_options.plist 
  #   artifacts:
  #     - build/ios/ipa/*.ipa
  #     - /tmp/xcodebuild_logs/*.log
  #     - flutter_drive.log
  #   publishing:
  #     app_store_connect: # For iOS or macOS app
  #       # For authenticating with App Store Connect and uploading the IPA to App Store Connect (required)
  #       api_key: $APP_STORE_CONNECT_PRIVATE_KEY
  #       key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER 
  #       issuer_id: $APP_STORE_CONNECT_ISSUER_ID 
        
  #       # Configuration related to TestFlight (optional)
  #       submit_to_testflight: true # Optional boolean, defaults to false. Whether or not to submit the uploaded build to TestFlight beta review. Required for distributing to beta groups. Note: This action is performed during post-processing.
  #       beta_groups: # Specify the names of beta tester groups that will get access to the build once it has passed beta review.
  #         - First Testers
  #         - First External Testers
        
  #       # Configuration related to App Store (optional)
  #       # submit_to_app_store: false # Optional boolean, defaults to false. Whether or not to submit the uploaded build to App Store review. Note: This action is performed during post-processing.
  #       # release_type: SCHEDULED # Optional, defaults to MANUAL. Supported values: MANUAL, AFTER_APPROVAL or SCHEDULED
  #       # earliest_release_date: 2021-12-01T14:00:00+00:00 # Optional. Timezone-aware ISO8601 timestamp with hour precision when scheduling the release. This can be only used when release type is set to SCHEDULED. It cannot be set to a date in the past.
  #       # copyright: 2022 Abraham Perez # Optional. The name of the person or entity that owns the exclusive rights to your app, preceded by the year the rights were obtained.
  #     slack:
  #       channel: '#bonobo'
  #       notify_on_build_start: true
  #       notify:
  #         success: true
  #         failure: false
  #     email:
  #       recipients:
  #         - aperezpe01@gmail.com
  #       notify:
  #         success: true
  #         failure: false
